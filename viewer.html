<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H5P Viewer</title>
  
  <!-- H5P Standalone CSS -->
  <link rel="stylesheet" href="https://unpkg.com/h5p-standalone@3.7.3/dist/styles/h5p.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f9fafb;
      padding: 20px;
    }
    
    #h5p-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
      min-height: 500px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: #ef4444;
      background: #fee;
      border-radius: 8px;
    }
    
    /* Styles H5P */
    .h5p-container {
      width: 100%;
    }
    
    .h5p-iframe-wrapper {
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <div id="h5p-container">
    <div class="loading">
      <div class="spinner"></div>
      <p style="color: #6366f1; font-size: 16px;">Chargement du contenu interactif H5P...</p>
    </div>
  </div>

  <!-- H5P Standalone JS -->
  <script src="https://unpkg.com/h5p-standalone@3.7.3/dist/main.bundle.js"></script>

  <script>
    const moduleId = '${id}';
    const basePath = `/h5p-modules/${moduleId}/content`;

    console.log('üöÄ H5P Interactive Viewer d√©marr√©');
    console.log('üì¶ Module ID:', moduleId);
    console.log('üìÇ Base path:', basePath);

    // Attendre que H5PStandalone soit charg√©
    function waitForH5P() {
      return new Promise((resolve) => {
        if (typeof H5PStandalone !== 'undefined') {
          resolve();
        } else {
          setTimeout(() => waitForH5P().then(resolve), 100);
        }
      });
    }

    async function loadInteractiveH5P() {
      const container = document.getElementById('h5p-container');
      
      try {
        console.log('1Ô∏è‚É£ Attente du chargement de H5PStandalone...');
        await waitForH5P();
        console.log('‚úÖ H5PStandalone charg√©');

        console.log('2Ô∏è‚É£ V√©rification des fichiers H5P...');
        
        // V√©rifier que h5p.json existe
        const h5pCheck = await fetch(`${basePath}/h5p.json`);
        if (!h5pCheck.ok) {
          throw new Error('Fichier h5p.json introuvable');
        }
        console.log('‚úÖ h5p.json trouv√©');

        console.log('3Ô∏è‚É£ Initialisation du lecteur H5P interactif...');
        
        // Cr√©er le conteneur pour H5P
        container.innerHTML = '<div id="h5p-player" style="width: 100%;"></div>';

        // Options H5P Standalone
        const options = {
          h5pJsonPath: basePath,
          frameJs: 'https://unpkg.com/h5p-standalone@3.7.3/dist/frame.bundle.js',
          frameCss: 'https://unpkg.com/h5p-standalone@3.7.3/dist/styles/h5p.css',
          frame: true,
          copyright: true,
          export: false,
          icon: true,
          fullScreen: false,
          downloadUrl: false
        };

        console.log('üìä Options H5P:', options);

        // Initialiser H5P
        const element = document.getElementById('h5p-player');
        const h5pInstance = new H5PStandalone.H5P(element, options);

        console.log('‚úÖ Contenu H5P interactif charg√© avec succ√®s!');
        console.log('üéÆ Vous pouvez maintenant interagir avec le contenu');

        // √âcouter les √©v√©nements H5P (optionnel)
        if (h5pInstance && h5pInstance.H5P) {
          h5pInstance.H5P.externalDispatcher.on('xAPI', (event) => {
            console.log('üìä √âv√©nement H5P:', event.getVerb(), event.data);
          });
        }

      } catch (error) {
        console.error('‚ùå Erreur de chargement:', error);
        
        container.innerHTML = `
          <div class="error">
            <h3>‚ùå Erreur de chargement</h3>
            <p style="margin-top: 10px; font-weight: 500;">${error.message}</p>
            <p style="margin-top: 15px; font-size: 14px; color: #666;">
              Le contenu H5P n'a pas pu √™tre charg√© de mani√®re interactive.
            </p>
            <details style="margin-top: 15px;">
              <summary style="cursor: pointer; padding: 10px; background: #f3f4f6; border-radius: 6px;">
                D√©tails techniques
              </summary>
              <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 12px; overflow: auto;">${error.stack || error.toString()}</pre>
            </details>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer;">
              R√©essayer
            </button>
          </div>
        `;
      }
    }

    // D√©marrer le chargement
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(loadInteractiveH5P, 100);
      });
    } else {
      setTimeout(loadInteractiveH5P, 100);
    }
  </script>
</body>
</html>